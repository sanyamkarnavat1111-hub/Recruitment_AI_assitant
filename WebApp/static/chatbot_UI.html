<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recruiter AI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <style>
    /* ==== Reset & Base ==== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Segoe UI', sans-serif;
      background: #f9fafb;
      color: #1f2937;
      line-height: 1.5;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* ==== Compact Header ==== */
    .header {
      text-align: center;
      padding: 16px 0;
      border-bottom: 1px solid #e5e7eb;
      background: #fff;
      border-radius: 12px 12px 0 0;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .05);
    }

    .greeting {
      font-size: 1.8rem;
      font-weight: 700;
      color: #6d28d9;
      margin-bottom: 4px;
    }

    .subtext {
      font-size: 0.95rem;
      color: #6b7280;
    }

    /* ==== Upload Section ==== */
    .upload-section {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .upload-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .upload-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: #374151;
    }

    .file-upload-wrapper {
      position: relative;
    }

    .file-upload {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-upload-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      background: #f3f4f6;
      border: 2px dashed #9ca3af;
      border-radius: 10px;
      color: #4b5563;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all .2s;
    }

    .file-upload-btn:hover {
      background: #e5e7eb;
      border-color: #6d28d9;
    }

    .file-name,
    .file-item span {
      font-size: 0.85rem;
      color: #16a34a;
      margin-top: 4px;
    }

    .file-list {
      margin-top: 6px;
      max-height: 100px;
      overflow-y: auto;
      font-size: 0.85rem;
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
      color: #16a34a;
    }

    .file-item i {
      color: #dc2626;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .upload-action {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .upload-action button {
      padding: 10px 20px;
      background: #6d28d9;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all .2s;
    }

    .upload-action button:hover {
      background: #5b21b6;
    }

    .upload-action button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    /* ==== Progress Bar ==== */
    .progress-container {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      margin-bottom: 8px;
    }

    .progress-bar {
      height: 100%;
      background: #6d28d9;
      width: 0;
      transition: width 0.2s ease;
    }

    .progress-text {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 0.7rem;
      font-weight: 600;
      color: #4b5563;
      line-height: 8px;
    }

    .progress-message {
      font-size: 0.85rem;
      color: #4b5563;
      text-align: center;
      margin-bottom: 8px;
    }

    /* ==== Persistent Resume Upload ==== */
    .resume-persistent {
      display: none;
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
    }

    /* ==== Chat Container ==== */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
      margin-bottom: 16px;
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #f9fafb;
    }

    .message {
      max-width: 78%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 0.95rem;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .user-message {
      align-self: flex-end;
      background: #6d28d9;
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .ai-message {
      align-self: flex-start;
      background: #f3f4f6;
      color: #1f2937;
      border-bottom-left-radius: 4px;
    }

    /* ==== Input Area with Paperclip ==== */
    .input-area {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: #fff;
      border-top: 1px solid #e5e7eb;
      gap: 10px;
    }

    .attach-btn {
      width: 40px;
      height: 40px;
      background: #f3f4f6;
      color: #6b7280;
      border: none;
      border-radius: 50%;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
    }

    .attach-btn:hover {
      background: #e5e7eb;
      color: #4b5563;
    }

    .attach-btn input {
      display: none;
    }

    .text-input {
      flex: 1;
      padding: 10px 16px;
      font-size: 0.95rem;
      border: 1px solid #d1d5db;
      border-radius: 50px;
      outline: none;
      transition: all .2s;
    }

    .text-input:focus {
      border-color: #6d28d9;
      box-shadow: 0 0 0 3px rgba(109, 40, 217, .1);
    }

    .send-btn {
      width: 40px;
      height: 40px;
      background: #6d28d9;
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
    }

    .send-btn:hover {
      background: #5b21b6;
    }

    .send-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    /* ==== File Pills ==== */
    .chat-file-preview {
      padding: 0 16px 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.8rem;
    }

    .chat-file-pill {
      background: #e0e7ff;
      color: #4f46e5;
      padding: 4px 10px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .chat-file-pill i {
      cursor: pointer;
      color: #7c3aed;
      font-size: 0.75rem;
    }

    .hidden {
      display: none !important;
    }

    /* ==== Scrollbars ==== */
    .chat-messages::-webkit-scrollbar,
    .file-list::-webkit-scrollbar {
      width: 5px;
    }

    .chat-messages::-webkit-scrollbar-track,
    .file-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb,
    .file-list::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Compact Header -->
    <div class="header">
      <h1 class="greeting">Recruiter AI</h1>
      <p class="subtext">Ask anything about resumes or upload documents</p>
    </div>

    <!-- UPLOAD SECTION -->
    <section class="upload-section" id="upload-section">
      <div class="upload-group" id="jd-group">
        <label class="upload-label">Job Description</label>
        <div class="file-upload-wrapper">
          <input type="file" id="jd-file" class="file-upload" accept=".pdf,.doc,.docx,.txt" />
          <div class="file-upload-btn">Choose File</div>
        </div>
        <div id="jd-name" class="file-name" style="display:none;"></div>
      </div>

      <div class="upload-group" id="resume-group">
        <label class="upload-label">Resumes</label>
        <div class="file-upload-wrapper">
          <input type="file" id="resume-file" class="file-upload" accept=".pdf,.doc,.docx,.txt" multiple />
          <div class="file-upload-btn">Choose Files</div>
        </div>
        <div id="resume-list" class="file-list" style="display:none;"></div>
      </div>

      <!-- Progress + Button -->
      <div class="upload-action">
        <div id="upload-progress" class="progress-container" style="display:none;">
          <div class="progress-bar" id="progress-bar"></div>
          <span id="progress-text" class="progress-text">0%</span>
        </div>
        <div id="progress-message" class="progress-message" style="display:none;"></div>
        <button id="upload-btn">Upload &amp; Analyze</button>
      </div>
    </section>

    <!-- PERSISTENT RESUME UPLOAD -->
    <section class="resume-persistent" id="resume-persistent" style="display:none;">

      <!-- GOOGLE SHEET URL INPUT -->
      <div class="upload-group">
        <label class="upload-label">Connect your Google Sheets</label>
        <div style="display:flex; gap:8px; align-items:stretch;">
          <input type="text" id="gsheet-url-input"
            placeholder="Provide publicly shareable url.."
            style="flex:1; padding:10px 14px; border:1px solid #d1d5db; border-radius:8px; font-size:0.9rem; outline:none;">
          <button id="add-gsheet-btn"
            style="padding:10px 20px; background:#6d28d9; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; white-space:nowrap;">
            Add Sheet
          </button>
        </div>
        <div id="gsheet-status" style="margin-top:6px; font-size:0.85rem; min-height:20px;"></div>
      </div>


      <div class="upload-group">
        <label class="upload-label">Add More Resumes</label>
        <div class="file-upload-wrapper">
          <input type="file" id="resume-file-persist" class="file-upload" accept=".pdf,.doc,.docx,.txt" multiple />
          <div class="file-upload-btn">Choose Files</div>
        </div>
        <div id="resume-list-persist" class="file-list" style="display:none;"></div>
      </div>

      <div class="upload-action">
        <div id="upload-more-progress" class="progress-container" style="display:none;">
          <div class="progress-bar" id="more-progress-bar"></div>
          <span id="more-progress-text" class="progress-text">0%</span>
        </div>
        <div id="more-progress-message" class="progress-message" style="display:none;"></div>
        <button id="upload-resume-btn">Upload More</button>
      </div>
    </section>

    <!-- CHAT -->
    <section class="chat-container hidden" id="chat-section">
      <div class="chat-messages" id="chat-messages"></div>

      <div class="input-area">
        <label class="attach-btn">
          <i class="fas fa-paperclip"></i>
          <input type="file" id="chat-file-input" multiple accept=".pdf,.docx,.txt" />
        </label>
        <input type="text" class="text-input" id="user-input" placeholder="Ask or upload files..." />
        <button class="send-btn" id="send-btn"><i class="fas fa-paper-plane"></i></button>
      </div>

      <div id="chat-file-preview" class="chat-file-preview" style="display:none;"></div>
    </section>
  </div>

  <script>
    const threadId = window.crypto.randomUUID();

    // DOM
    const uploadSection = document.getElementById('upload-section');
    const resumePersistent = document.getElementById('resume-persistent');
    const chatSection = document.getElementById('chat-section');

    const jdGroup = document.getElementById('jd-group');
    const jdInput = document.getElementById('jd-file');
    const jdName = document.getElementById('jd-name');

    const resumeInput = document.getElementById('resume-file');
    const resumeList = document.getElementById('resume-list');
    const resumeInputPersist = document.getElementById('resume-file-persist');
    const resumeListPersist = document.getElementById('resume-list-persist');

    const uploadBtn = document.getElementById('upload-btn');
    const uploadResumeBtn = document.getElementById('upload-resume-btn');

    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const chatMessages = document.getElementById('chat-messages');
    const chatFileInput = document.getElementById('chat-file-input');
    const chatFilePreview = document.getElementById('chat-file-preview');

    const gsheetInput = document.getElementById('gsheet-url-input');
    const addGsheetBtn = document.getElementById('add-gsheet-btn');
    const gsheetStatus = document.getElementById('gsheet-status');


    // Progress Elements
    const progressEls = {
      initial: {
        container: document.getElementById('upload-progress'),
        bar: document.getElementById('progress-bar'),
        text: document.getElementById('progress-text'),
        message: document.getElementById('progress-message')
      },
      more: {
        container: document.getElementById('upload-more-progress'),
        bar: document.getElementById('more-progress-bar'),
        text: document.getElementById('more-progress-text'),
        message: document.getElementById('more-progress-message')
      }
    };

    let jdFile = null;
    let resumeFiles = [];
    let jdUploaded = false;
    let chatStarted = false;
    let chatFiles = [];
    let currentEventSource = null;

    /* ====================== JD & Resume Setup ====================== */
    jdInput.addEventListener('change', e => {
      jdFile = e.target.files[0] || null;
      jdName.textContent = jdFile?.name ?? '';
      jdName.style.display = jdFile ? 'block' : 'none';
      toggleButtons();
    });

    function showStatus(msg, type = 'info') {
      gsheetStatus.textContent = msg;
      gsheetStatus.style.color = type === 'success' ? '#16a34a' :
        type === 'error' ? '#dc2626' : '#4b5563';
    }

    addGsheetBtn.addEventListener('click', async () => {
      let url = gsheetInput.value.trim();

      if (!url) {
        showStatus('Please enter a URL', 'error');
        return;
      }

      // Very light validation – backend will do the real check
      try { new URL(url); } catch {
        showStatus('Please enter a valid URL', 'error');
        return;
      }

      // UI feedback
      addGsheetBtn.disabled = true;
      addGsheetBtn.textContent = 'Adding...';
      showStatus('Processing sheet...', 'info');

      const formData = new FormData();
      formData.append('thread_id', threadId);
      formData.append('url', url);

      try {
        const response = await fetch('/upload_google_sheet_csv', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (response.ok && result.success) {
          showStatus(result.message || 'Sheet added successfully!', 'success');
          addMessage('ai', `Google Sheet added to knowledge base.`);
          gsheetInput.value = '';          // clear on success
        } else {
          showStatus(result.message || 'Failed to add sheet', 'error');
        }
      } catch (err) {
        console.error(err);
        showStatus('Network error – check console', 'error');
      } finally {
        addGsheetBtn.disabled = false;
        addGsheetBtn.textContent = 'Add Sheet';
      }
    });

    // Allow pressing Enter
    gsheetInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') addGsheetBtn.click();
    });

    function setupResumeInput(input, list) {
      input.addEventListener('change', e => {
        resumeFiles = [...resumeFiles, ...Array.from(e.target.files)];
        renderResumeList(list);
        toggleButtons();
      });
    }

    function renderResumeList(listEl) {
      if (!resumeFiles.length) { listEl.style.display = 'none'; return; }
      listEl.innerHTML = '';
      resumeFiles.forEach((f, i) => {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `<span>${f.name}</span><i class="fas fa-times" data-index="${i}"></i>`;
        listEl.appendChild(div);
      });
      listEl.querySelectorAll('.fa-times').forEach(ic => {
        ic.addEventListener('click', () => {
          resumeFiles.splice(+ic.dataset.index, 1);
          renderResumeList(listEl);
          toggleButtons();
        });
      });
      listEl.style.display = 'block';
    }

    setupResumeInput(resumeInput, resumeList);
    setupResumeInput(resumeInputPersist, resumeListPersist);

    function clearResumeUI() {
      resumeFiles = [];
      renderResumeList(resumeList);
      renderResumeList(resumeListPersist);
    }

    function toggleButtons() {
      const hasResumes = resumeFiles.length > 0;
      const canUploadJD = !jdUploaded && jdFile;
      uploadBtn.disabled = !(canUploadJD || (jdUploaded && hasResumes));
      uploadResumeBtn.disabled = !hasResumes;
    }

    /* ====================== UPLOAD WITH SSE PROGRESS ====================== */
    async function startResumeUpload(type) {
      const els = progressEls[type];
      els.container.style.display = 'block';
      els.bar.style.width = '0%';
      els.text.textContent = '0%';
      els.message.style.display = 'block';
      els.message.textContent = 'Starting...';

      const form = new FormData();
      form.append('thread_id', threadId);
      resumeFiles.forEach(f => form.append('resume_files', f));

      try {
        const res = await fetch(`${window.location.origin}/upload_resume`, {
          method: 'POST',
          body: form
        });
        if (!res.ok) throw new Error(await res.text());
        const { task_id } = await res.json();

        // Close any existing stream
        if (currentEventSource) currentEventSource.close();

        currentEventSource = new EventSource(`${window.location.origin}/progress/${task_id}`);

        currentEventSource.onmessage = (e) => {
          const data = JSON.parse(e.data);
          if (data.error) {
            currentEventSource.close();
            throw new Error(data.error);
          }
          if (data.progress !== undefined) {
            els.bar.style.width = `${data.progress}%`;
            els.text.textContent = `${data.progress}%`;
            if (data.message) els.message.textContent = data.message;
          }
          if (data.status === 'completed') {
            currentEventSource.close();
            handleUploadComplete(data.data, type);
          } else if (data.status === 'failed') {
            currentEventSource.close();
            throw new Error(data.message || 'Upload failed');
          }
        };

        currentEventSource.onerror = () => {
          currentEventSource.close();
          throw new Error('Connection lost');
        };

      } catch (err) {
        els.container.style.display = 'none';
        els.message.style.display = 'none';
        alert(err.message);
        throw err;
      }
    }

    function handleUploadComplete(data, type) {
      const els = progressEls[type];
      clearResumeUI();

      if (type === 'initial' && !chatStarted) {
        uploadSection.classList.add('hidden');
        resumePersistent.style.display = 'block';
        chatSection.classList.remove('hidden');
        chatStarted = true;
      }

      addMessage('ai', `Processed ${data.processed_count} resume(s).`);
      if (data.failed_count > 0) addMessage('ai', `${data.failed_count} failed.`);
      if (data.fittest_candidates) addMessage('ai', data.fittest_candidates);

      // Hide progress
      els.container.style.display = 'none';
      els.message.style.display = 'none';
    }

    /* ====================== INITIAL UPLOAD ====================== */
    uploadBtn.addEventListener('click', async () => {
      if (uploadBtn.disabled) return;
      uploadBtn.disabled = true;
      uploadBtn.innerHTML = 'Starting...';

      try {
        if (!jdUploaded) {
          await uploadJD();
          jdUploaded = true;
          jdGroup.style.display = 'none';
          jdName.style.display = 'none';
          jdInput.value = '';
          jdFile = null;
        }
        await startResumeUpload('initial');
      } catch (err) {
        // Handled in startResumeUpload
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = 'Upload &amp; Analyze';
        toggleButtons();
      }
    });

    /* ====================== UPLOAD MORE ====================== */
    uploadResumeBtn.addEventListener('click', async () => {
      if (uploadResumeBtn.disabled) return;
      uploadBtn.disabled = true;
      uploadResumeBtn.innerHTML = 'Starting...';

      try {
        await startResumeUpload('more');
      } catch (err) {
        // Handled
      } finally {
        uploadResumeBtn.disabled = false;
        uploadResumeBtn.innerHTML = 'Upload More';
        toggleButtons();
      }
    });

    /* ====================== UPLOAD JD ====================== */
    async function uploadJD() {
      const form = new FormData();
      form.append('thread_id', threadId);
      form.append('job_description_file', jdFile);
      const res = await fetch(`${window.location.origin}/upload_job_description`, { method: 'POST', body: form });
      if (!res.ok) throw new Error(`JD upload failed`);
      return res.json();
    }

    /* ====================== CHAT FILE UPLOAD ====================== */
    chatFileInput.addEventListener('change', e => {
      chatFiles = [...chatFiles, ...Array.from(e.target.files)];
      renderChatFilePills();
    });

    function renderChatFilePills() {
      if (!chatFiles.length) {
        chatFilePreview.style.display = 'none';
        return;
      }
      chatFilePreview.innerHTML = '';
      chatFiles.forEach((f, i) => {
        const pill = document.createElement('div');
        pill.className = 'chat-file-pill';
        pill.innerHTML = `${f.name}<i class="fas fa-times" data-index="${i}"></i>`;
        chatFilePreview.appendChild(pill);
      });
      chatFilePreview.querySelectorAll('.fa-times').forEach(ic => {
        ic.addEventListener('click', () => {
          chatFiles.splice(+ic.dataset.index, 1);
          renderChatFilePills();
        });
      });
      chatFilePreview.style.display = 'flex';
    }

    async function uploadChatFiles() {
      if (!chatFiles.length) return null;
      const form = new FormData();
      form.append('thread_id', threadId);
      chatFiles.forEach(f => form.append('files', f));
      const res = await fetch(`${window.location.origin}/upload_files`, { method: 'POST', body: form });
      if (!res.ok) throw new Error(`Upload failed: ${await res.text()}`);
      return res.json();
    }

    /* ====================== SEND MESSAGE ====================== */
    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text && !chatFiles.length) return;

      if (text) addMessage('user', text);
      userInput.value = '';

      let fileRes = null;
      if (chatFiles.length) {
        try {
          fileRes = await uploadChatFiles();
          addMessage('ai', `Uploaded ${chatFiles.length} file(s) to knowledge base.`);
        } catch (err) {
          addMessage('ai', `File upload failed.`);
        }
        chatFiles = [];
        renderChatFilePills();
      }

      if (text) {
        const form = new FormData();
        form.append('thread_id', threadId);
        form.append('query', text);
        if (fileRes) form.append('uploaded_files', JSON.stringify(fileRes));
        try {
          const res = await fetch(`${window.location.origin}/query`, { method: 'POST', body: form });
          const data = await res.json();
          addMessage('ai', data.response || 'No response.');
        } catch (e) {
          addMessage('ai', 'Error: Server unreachable.');
        }
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', e => e.key === 'Enter' && sendMessage());

    function addMessage(sender, text) {
      const div = document.createElement('div');
      div.className = `message ${sender}-message`;
      if (sender === 'ai') {
        let html = marked.parse(text);
        if (text.includes('analysis') && html.includes('<pre><code')) {
          html = html.replace(/<pre><code[^>]*>([\s\S]*?)<\/code><\/pre>/gi,
            (m, c) => `<div class="analysis-plain">${c.replace(/\n/g, '<br>')}</div>`);
        }
        div.innerHTML = DOMPurify.sanitize(html);
      } else {
        div.textContent = text;
      }
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    toggleButtons();
  </script>
</body>

</html>