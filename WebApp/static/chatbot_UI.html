<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recruiter AI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <style>
    /* ==== Reset & Base ==== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Segoe UI', sans-serif;
      background: #f9fafb;
      color: #1f2937;
      line-height: 1.5;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* ==== Compact Header ==== */
    .header {
      text-align: center;
      padding: 16px 0;
      border-bottom: 1px solid #e5e7eb;
      background: #fff;
      border-radius: 12px 12px 0 0;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .05);
    }

    .greeting {
      font-size: 1.8rem;
      font-weight: 700;
      color: #6d28d9;
      margin-bottom: 4px;
    }

    .subtext {
      font-size: 0.95rem;
      color: #6b7280;
    }

    /* ==== Upload Section ==== */
    .upload-section {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .upload-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .upload-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: #374151;
    }

    .file-upload-wrapper {
      position: relative;
    }

    .file-upload {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-upload-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      background: #f3f4f6;
      border: 2px dashed #9ca3af;
      border-radius: 10px;
      color: #4b5563;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all .2s;
    }

    .file-upload-btn:hover {
      background: #e5e7eb;
      border-color: #6d28d9;
    }

    .file-name,
    .file-item span {
      font-size: 0.85rem;
      color: #16a34a;
      margin-top: 4px;
    }

    .file-list {
      margin-top: 6px;
      max-height: 100px;
      overflow-y: auto;
      font-size: 0.85rem;
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
      color: #16a34a;
    }

    .file-item i {
      color: #dc2626;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .upload-action {
      display: flex;
      justify-content: flex-end;
      margin-top: 8px;
    }

    .upload-action button {
      padding: 10px 20px;
      background: #6d28d9;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all .2s;
    }

    .upload-action button:hover {
      background: #5b21b6;
    }

    .upload-action button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    /* ==== Persistent Resume Upload ==== */
    .resume-persistent {
      display: none;
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
    }

    /* ==== Chat Container ==== */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
      margin-bottom: 16px;
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #f9fafb;
    }

    .message {
      max-width: 78%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 0.95rem;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .user-message {
      align-self: flex-end;
      background: #6d28d9;
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .ai-message {
      align-self: flex-start;
      background: #f3f4f6;
      color: #1f2937;
      border-bottom-left-radius: 4px;
    }

    /* ==== Input Area with Paperclip ==== */
    .input-area {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: #fff;
      border-top: 1px solid #e5e7eb;
      gap: 10px;
    }

    .attach-btn {
      width: 40px;
      height: 40px;
      background: #f3f4f6;
      color: #6b7280;
      border: none;
      border-radius: 50%;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
    }

    .attach-btn:hover {
      background: #e5e7eb;
      color: #4b5563;
    }

    .attach-btn input {
      display: none;
    }

    .text-input {
      flex: 1;
      padding: 10px 16px;
      font-size: 0.95rem;
      border: 1px solid #d1d5db;
      border-radius: 50px;
      outline: none;
      transition: all .2s;
    }

    .text-input:focus {
      border-color: #6d28d9;
      box-shadow: 0 0 0 3px rgba(109, 40, 217, .1);
    }

    .send-btn {
      width: 40px;
      height: 40px;
      background: #6d28d9;
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s;
    }

    .send-btn:hover {
      background: #5b21b6;
    }

    .send-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    /* ==== Clean File Pills in Chat Input ==== */
    .chat-file-preview {
      padding: 0 16px 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.8rem;
    }

    .chat-file-pill {
      background: #e0e7ff;
      color: #4f46e5;
      padding: 4px 10px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .chat-file-pill i {
      cursor: pointer;
      color: #7c3aed;
      font-size: 0.75rem;
    }

    .hidden {
      display: none !important;
    }

    /* ==== Markdown & Code ==== */
    .ai-message pre {
      background: #1f2937;
      color: #e5e7eb;
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 0.85rem;
      margin: 8px 0;
    }

    .analysis-plain {
      background: transparent;
      padding: 0;
      margin: 8px 0;
      white-space: pre-wrap;
    }

    /* ==== Scrollbars ==== */
    .chat-messages::-webkit-scrollbar,
    .file-list::-webkit-scrollbar {
      width: 5px;
    }

    .chat-messages::-webkit-scrollbar-track,
    .file-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb,
    .file-list::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    /* ==== Responsive ==== */
    @media (max-width:640px) {
      .container {
        padding: 12px;
      }

      .greeting {
        font-size: 1.6rem;
      }

      .upload-section,
      .resume-persistent {
        padding: 16px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Compact Header -->
    <div class="header">
      <h1 class="greeting">Recruiter AI</h1>
      <p class="subtext">Ask anything about resumes or upload documents</p>
    </div>

    <!-- UPLOAD SECTION -->
    <section class="upload-section" id="upload-section">
      <div class="upload-group" id="jd-group">
        <label class="upload-label">Job Description</label>
        <div class="file-upload-wrapper">
          <input type="file" id="jd-file" class="file-upload" accept=".pdf,.doc,.docx,.txt" />
          <div class="file-upload-btn">Choose File</div>
        </div>
        <div id="jd-name" class="file-name" style="display:none;"></div>
      </div>

      <div class="upload-group" id="resume-group">
        <label class="upload-label">Resumes</label>
        <div class="file-upload-wrapper">
          <input type="file" id="resume-file" class="file-upload" accept=".pdf,.doc,.docx,.txt" multiple />
          <div class="file-upload-btn">Choose Files</div>
        </div>
        <div id="resume-list" class="file-list" style="display:none;"></div>
      </div>

      <div class="upload-action">
        <button id="upload-btn">Upload &amp; Analyze</button>
      </div>
    </section>

    <!-- PERSISTENT RESUME UPLOAD -->
    <section class="resume-persistent" id="resume-persistent" style="display:none;">
      <div class="upload-group">
        <label class="upload-label">Add More Resumes</label>
        <div class="file-upload-wrapper">
          <input type="file" id="resume-file-persist" class="file-upload" accept=".pdf,.doc,.docx,.txt" multiple />
          <div class="file-upload-btn">Choose Files</div>
        </div>
        <div id="resume-list-persist" class="file-list" style="display:none;"></div>
      </div>
      <div class="upload-action">
        <button id="upload-resume-btn">Upload More</button>
      </div>
    </section>

    <!-- CHAT -->
    <section class="chat-container hidden" id="chat-section">
      <div class="chat-messages" id="chat-messages"></div>

      <!-- Input with Paperclip + Clean File Pills -->
      <div class="input-area">
        <label class="attach-btn">
          <i class="fas fa-paperclip"></i>
          <input type="file" id="chat-file-input" multiple accept=".pdf,.doc,.docx,.txt,.csv,.json,.xlsx,.pptx" />
        </label>
        <input type="text" class="text-input" id="user-input" placeholder="Ask or upload files..." />
        <button class="send-btn" id="send-btn"><i class="fas fa-paper-plane"></i></button>
      </div>

      <div id="chat-file-preview" class="chat-file-preview" style="display:none;"></div>
    </section>
  </div>

  <script>
    const threadId = window.crypto.randomUUID();

    // DOM
    const uploadSection = document.getElementById('upload-section');
    const resumePersistent = document.getElementById('resume-persistent');
    const chatSection = document.getElementById('chat-section');

    const jdGroup = document.getElementById('jd-group');
    const jdInput = document.getElementById('jd-file');
    const jdName = document.getElementById('jd-name');

    const resumeInput = document.getElementById('resume-file');
    const resumeList = document.getElementById('resume-list');
    const resumeInputPersist = document.getElementById('resume-file-persist');
    const resumeListPersist = document.getElementById('resume-list-persist');

    const uploadBtn = document.getElementById('upload-btn');
    const uploadResumeBtn = document.getElementById('upload-resume-btn');

    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const chatMessages = document.getElementById('chat-messages');
    const chatFileInput = document.getElementById('chat-file-input');
    const chatFilePreview = document.getElementById('chat-file-preview');

    let jdFile = null;
    let resumeFiles = [];
    let jdUploaded = false;
    let chatStarted = false;
    let chatFiles = [];

    /* ====================== JD & Resume ====================== */
    jdInput.addEventListener('change', e => {
      jdFile = e.target.files[0] || null;
      jdName.textContent = jdFile?.name ?? '';
      jdName.style.display = jdFile ? 'block' : 'none';
      toggleButtons();
    });

    function setupResumeInput(input, list) {
      input.addEventListener('change', e => {
        resumeFiles = [...resumeFiles, ...Array.from(e.target.files)];
        renderResumeList(list);
        toggleButtons();
      });
    }

    function renderResumeList(listEl) {
      if (!resumeFiles.length) { listEl.style.display = 'none'; return; }
      listEl.innerHTML = '';
      resumeFiles.forEach((f, i) => {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `<span>${f.name}</span><i class="fas fa-times" data-index="${i}"></i>`;
        listEl.appendChild(div);
      });
      listEl.querySelectorAll('.fa-times').forEach(ic => {
        ic.addEventListener('click', () => {
          resumeFiles.splice(+ic.dataset.index, 1);
          renderResumeList(listEl);
          toggleButtons();
        });
      });
      listEl.style.display = 'block';
    }

    setupResumeInput(resumeInput, resumeList);
    setupResumeInput(resumeInputPersist, resumeListPersist);

    function clearResumeUI() {
      resumeFiles = [];
      renderResumeList(resumeList);
      renderResumeList(resumeListPersist);
    }

    function toggleButtons() {
      const hasResumes = resumeFiles.length > 0;
      const canUploadJD = !jdUploaded && jdFile;
      uploadBtn.disabled = !(canUploadJD || (jdUploaded && hasResumes));
      uploadResumeBtn.disabled = !hasResumes;
    }

    /* ====================== Chat File Upload (Paperclip) ====================== */
    chatFileInput.addEventListener('change', e => {
      chatFiles = [...chatFiles, ...Array.from(e.target.files)];
      renderChatFilePills();
    });

    function renderChatFilePills() {
      if (!chatFiles.length) {
        chatFilePreview.style.display = 'none';
        return;
      }
      chatFilePreview.innerHTML = '';
      chatFiles.forEach((f, i) => {
        const pill = document.createElement('div');
        pill.className = 'chat-file-pill';
        pill.innerHTML = `${f.name}<i class="fas fa-times" data-index="${i}"></i>`;
        chatFilePreview.appendChild(pill);
      });
      chatFilePreview.querySelectorAll('.fa-times').forEach(ic => {
        ic.addEventListener('click', () => {
          chatFiles.splice(+ic.dataset.index, 1);
          renderChatFilePills();
        });
      });
      chatFilePreview.style.display = 'flex';
    }

    async function uploadChatFiles() {
      if (!chatFiles.length) return null;
      const form = new FormData();
      form.append('thread_id', threadId);
      chatFiles.forEach(f => form.append('files', f));
      const res = await fetch(`${window.location.origin}/upload_files`, { method: 'POST', body: form });
      if (!res.ok) throw new Error(`Upload failed: ${await res.text()}`);
      return res.json();
    }

    /* ====================== Upload JD & Resumes ====================== */
    async function uploadJD() {
      const form = new FormData();
      form.append('thread_id', threadId);
      form.append('job_description_file', jdFile);
      const res = await fetch(`${window.location.origin}/upload_job_description`, { method: 'POST', body: form });
      if (!res.ok) throw new Error(`JD upload failed`);
      return res.json();
    }

    async function uploadResumes() {
      const form = new FormData();
      form.append('thread_id', threadId);
      resumeFiles.forEach(f => form.append('resume_files', f));
      const res = await fetch(`${window.location.origin}/upload_resume`, { method: 'POST', body: form });
      if (!res.ok) throw new Error(`Resume upload failed`);
      return res.json();
    }

    uploadBtn.addEventListener('click', async () => {
      if (uploadBtn.disabled) return;
      uploadBtn.disabled = true;
      uploadBtn.innerHTML = 'Uploading…';

      try {
        if (!jdUploaded) {
          await uploadJD();
          jdUploaded = true;
          jdGroup.style.display = 'none';
          jdName.style.display = 'none';
          jdInput.value = '';
          jdFile = null;
        }
        const data = await uploadResumes();
        clearResumeUI();

        if (!chatStarted) {
          uploadSection.classList.add('hidden');
          resumePersistent.style.display = 'block';
          chatSection.classList.remove('hidden');
          chatStarted = true;
        }

        addMessage('ai', `Processed ${data.processed_count} resume(s).`);
        if (data.fittest_candidates) addMessage('ai', data.fittest_candidates);
      } catch (err) { alert(err.message); }
      finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = 'Upload &amp; Analyze';
        toggleButtons();
      }
    });

    uploadResumeBtn.addEventListener('click', async () => {
      if (uploadResumeBtn.disabled) return;
      uploadResumeBtn.disabled = true;
      uploadResumeBtn.innerHTML = 'Uploading…';
      try {
        const data = await uploadResumes();
        clearResumeUI();
        addMessage('ai', `+${data.processed_count} resume(s) added.`);
        if (data.fittest_candidates) {
          addMessage('ai', data.fittest_candidates);  // Now shown on every upload
        }
      } catch (err) { alert(err.message); }
      finally {
        uploadResumeBtn.disabled = false;
        uploadResumeBtn.innerHTML = 'Upload More';
        toggleButtons();
      }
    });

    /* ====================== Send Message ====================== */
    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text && !chatFiles.length) return;

      if (text) addMessage('user', text);
      userInput.value = '';

      let fileRes = null;
      if (chatFiles.length) {
        try {
          fileRes = await uploadChatFiles();
          addMessage('ai', `Uploaded ${chatFiles.length} file(s) to knowledge base.`);
        } catch (err) {
          addMessage('ai', `File upload failed.`);
        }
        chatFiles = [];
        renderChatFilePills();
      }

      if (text) {
        const form = new FormData();
        form.append('thread_id', threadId);
        form.append('query', text);
        if (fileRes) form.append('uploaded_files', JSON.stringify(fileRes));
        try {
          const res = await fetch(`${window.location.origin}/query`, { method: 'POST', body: form });
          const data = await res.json();
          addMessage('ai', data.response || 'No response.');
        } catch (e) {
          addMessage('ai', 'Error: Server unreachable.');
        }
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', e => e.key === 'Enter' && sendMessage());

    function addMessage(sender, text) {
      const div = document.createElement('div');
      div.className = `message ${sender}-message`;
      if (sender === 'ai') {
        let html = marked.parse(text);
        if (text.includes('analysis') && html.includes('<pre><code')) {
          html = html.replace(/<pre><code[^>]*>([\s\S]*?)<\/code><\/pre>/gi,
            (m, c) => `<div class="analysis-plain">${c.replace(/\n/g, '<br>')}</div>`);
        }
        div.innerHTML = DOMPurify.sanitize(html);
      } else {
        div.textContent = text;
      }
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    toggleButtons();
  </script>
</body>

</html>